<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="记录者">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="记录者">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记录者">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>记录者</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">记录者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我们坚持一件事情，并不是因为这样做了会有效果，而是坚信，这样做是对的。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/android自动化打包脚本搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/android自动化打包脚本搭建/" itemprop="url">android自动化打包脚本搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T17:25:39+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>从之前分析学习安卓的打包流程，然后参考各式方案，再结合项目需求，定下了一套目前来讲比较好的打包方法。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>安卓打包流程如下<br><img src="/images/android/androidpackageimage.png" alt="打包流程"></p>
<p>通过apkbuilder构建之后就形成了未签名的apk包，然后通过jarsinger进行签名之后，就会生成签名的apk包。</p>
<p>换言之，在jarsinger签名之前的任何步骤，进行的操作，都需要重新经过apkbuilder，否则就不会生效，类似于R文件的生成，假如在apkbuilder之后重新想塞入一些资源，那么R文件是读不出来这些文件的。同时如果资源文件的错位，或许会导致之后索引产生一系列问题。最大的问题是，假如改了apkbuilder涉及的文件，会导致签名校验失败。</p>
<p>因此只能通过不参与签名校验的文件进行操作，唯一可以改的就是META-INF目录。</p>
<p>所以将需要放置的文件放到META-INF目录之后在进行对齐即可。</p>
<h1 id="项目变更"><a href="#项目变更" class="headerlink" title="项目变更"></a>项目变更</h1><p>由于市场的要求，我们的app在不同的平台上有不同的名字，比如在baidu上面，就是“好搭盒子”，而在小米和搜狗市场上面，叫“好搭盒子-穿衣搭配”，在其余的市场上面，叫”好搭盒子-教你穿衣搭配”。</p>
<p>虽然看起来只是名字的改变，但是如果通过打包想法来讲，改名字需要改manifest，这样就会导致签名验证失败，因此无法通过manifest改名字。</p>
<p>我的想法和行动是仍旧构建变体，分三个，一个是shortname变体，一个是middlename变体，另一个是longname变体，其实还有一种，是测试时候的dev变体（因为测试人员需要知道我给他的是debug包，通过名字知道是最直接的）</p>
<p>因此通过输入渠道的变化，构造不同的变体，但是对于已有构建好的就不需要重复构建了。</p>
<h1 id="打包脚本"><a href="#打包脚本" class="headerlink" title="打包脚本"></a>打包脚本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">import zipfile</span><br><span class="line">import shutil</span><br><span class="line">import os</span><br><span class="line">import sys</span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import urllib2</span><br><span class="line">import subprocess</span><br><span class="line">import pwd</span><br><span class="line">import os</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">findline = u&quot;(versionCode\s+:.+)&quot;</span><br><span class="line">findversion = u&quot;([0-9]+)&quot;</span><br><span class="line">findversionname = u&quot;(?&lt;= versionName      : \&quot;).+?(?=\&quot;)&quot;</span><br><span class="line">depgradlefilepath = &quot;dependencies.gradle&quot;</span><br><span class="line">BRANCH = &quot;dev&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def release(channelName):</span><br><span class="line">    channelName = channelName</span><br><span class="line">    print &apos;start build &apos; + channelName</span><br><span class="line"></span><br><span class="line">    apk = &apos;./app/build/outputs/apk/dev/release/app-dev-release.apk&apos;</span><br><span class="line">    hasApk = os.path.exists(apk)</span><br><span class="line">    path = &apos;./release_apks/dev/&apos;</span><br><span class="line">    clean_code = subprocess.check_call(&quot;./gradlew clean&quot;, shell=True)</span><br><span class="line">    if clean_code != 0:</span><br><span class="line">        print &quot;clean failed&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    if channelName == &apos;long&apos;:</span><br><span class="line">        apk = &apos;./app/build/outputs/apk/longname/release/app-longname-release.apk&apos;</span><br><span class="line">        path = &apos;./release_apks/long/&apos;</span><br><span class="line">        if os.path.exists(&quot;release_apks/long&quot;):</span><br><span class="line">            shutil.rmtree(&quot;release_apks/long&quot;)</span><br><span class="line">        print &quot;delete exist release_apks/long success&quot;</span><br><span class="line">        os.mkdir(&quot;release_apks/long&quot;)</span><br><span class="line">        assemble_release_code = subprocess.check_call(&quot;./gradlew assembleLongnameRelease&quot;,</span><br><span class="line">                                                      shell=True)</span><br><span class="line">    elif channelName == &apos;short&apos;:</span><br><span class="line">        apk = &apos;./app/build/outputs/apk/shortname/release/app-shortname-release.apk&apos;</span><br><span class="line">        path = &apos;./release_apks/short/&apos;</span><br><span class="line">        if os.path.exists(&quot;release_apks/short&quot;):</span><br><span class="line">            shutil.rmtree(&quot;release_apks/short&quot;)</span><br><span class="line">        print &quot;delete exist release_apks/short success&quot;</span><br><span class="line">        os.mkdir(&quot;release_apks/short&quot;)</span><br><span class="line">        assemble_release_code = subprocess.check_call(&quot;./gradlew assembleShortnameRelease&quot;,</span><br><span class="line">                                                      shell=True)</span><br><span class="line">    elif channelName == &apos;middle&apos;:</span><br><span class="line">        apk = &apos;./app/build/outputs/apk/middlename/release/app-middlename-release.apk&apos;</span><br><span class="line">        path = &apos;./release_apks/middle/&apos;</span><br><span class="line">        if os.path.exists(&quot;release_apks/middle&quot;):</span><br><span class="line">            shutil.rmtree(&quot;release_apks/middle&quot;)</span><br><span class="line">        print &quot;delete exist release_apks/middle success&quot;</span><br><span class="line">        os.mkdir(&quot;release_apks/middle&quot;)</span><br><span class="line">        assemble_release_code = subprocess.check_call(&quot;./gradlew assembleMiddlenameRelease&quot;,</span><br><span class="line">                                                      shell=True)</span><br><span class="line">    else:</span><br><span class="line">        if os.path.exists(&quot;release_apks/dev&quot;):</span><br><span class="line">            shutil.rmtree(&quot;release_apks/dev&quot;)</span><br><span class="line">        print &quot;delete exist release_apks/dev success&quot;</span><br><span class="line">        os.mkdir(&quot;release_apks/dev&quot;)</span><br><span class="line">        assemble_release_code = subprocess.check_call(&quot;./gradlew assembleDevRelease&quot;, shell=True)</span><br><span class="line"></span><br><span class="line">    if assemble_release_code != 0:</span><br><span class="line">        print &quot;assembleRelease failed&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    emptyFile = &apos;xxx.txt&apos;</span><br><span class="line">    f = open(emptyFile, &apos;w&apos;)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">    if channelName == &apos;long&apos;:</span><br><span class="line">        with open(&apos;channelNameLong.txt&apos;, &apos;r&apos;) as f:</span><br><span class="line">            contens = f.read()</span><br><span class="line">        lines = contens.split(&apos;\n&apos;)</span><br><span class="line">    elif channelName == &apos;short&apos;:</span><br><span class="line">        with open(&apos;channelNameShort.txt&apos;, &apos;r&apos;) as f:</span><br><span class="line">            contens = f.read()</span><br><span class="line">        lines = contens.split(&apos;\n&apos;)</span><br><span class="line">    elif channelName == &apos;middle&apos;:</span><br><span class="line">        with open(&apos;channelNameMiddle.txt&apos;, &apos;r&apos;) as f:</span><br><span class="line">            contens = f.read()</span><br><span class="line">        lines = contens.split(&apos;\n&apos;)</span><br><span class="line">    else:</span><br><span class="line">        with open(&apos;devChannel.txt&apos;, &apos;r&apos;) as f:</span><br><span class="line">            contens = f.read()</span><br><span class="line">        lines = contens.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">    if not os.path.exists(path):</span><br><span class="line">        os.mkdir(path)</span><br><span class="line">    else:</span><br><span class="line">        for f in os.listdir(path):</span><br><span class="line">            if not f.endswith(&apos;.gitignore&apos;):</span><br><span class="line">                os.remove(path + f)</span><br><span class="line"></span><br><span class="line">    for line in lines:</span><br><span class="line">        print line</span><br><span class="line">        channel = &apos;channel_&apos; + line</span><br><span class="line">        destfile = path + &apos;%s.apk&apos; % channel</span><br><span class="line">        shutil.copyfile(apk, destfile)</span><br><span class="line">        zipped = zipfile.ZipFile(destfile, &apos;a&apos;, zipfile.ZIP_DEFLATED)</span><br><span class="line">        channelFile = &quot;META-INF/&#123;channelname&#125;&quot;.format(channelname=channel)</span><br><span class="line">        zipped.write(emptyFile, channelFile)</span><br><span class="line">        zipped.close()</span><br><span class="line">    os.remove(&apos;./xxx.txt&apos;)</span><br><span class="line"></span><br><span class="line">    for f in os.listdir(path):</span><br><span class="line">        if f.endswith(&apos;.apk&apos;):</span><br><span class="line">            os.system(&apos;zipalign -f -v 4 &apos; + path + f + &apos; &apos; + path + &apos;temp-&apos; + f)</span><br><span class="line">            os.remove(path + f)</span><br><span class="line"></span><br><span class="line">    for f in os.listdir(path):</span><br><span class="line">        if f.startswith(&apos;temp-&apos;):</span><br><span class="line">            os.system(&apos;zipalign -f -v 4 &apos; + path + f + &apos; &apos; + path + f.replace(&apos;temp-&apos;, &apos;&apos;))</span><br><span class="line">            os.remove(path + f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def versionCodePlusPlus(msg):</span><br><span class="line">    gitstash = subprocess.check_call(&quot;git stash&quot;, shell=True)</span><br><span class="line">    if gitstash != 0:</span><br><span class="line">        print &quot;git stash fail&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    print &quot;git stash success&quot;</span><br><span class="line">    gitcheckout = subprocess.check_call(&quot;git checkout &quot; + BRANCH, shell=True)</span><br><span class="line">    if gitcheckout != 0:</span><br><span class="line">        print &quot;git checkout dev fail&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    print &quot;git checkout dev success&quot;</span><br><span class="line">    gitfetchall = subprocess.check_call(&quot;git fetch --all&quot;, shell=True)</span><br><span class="line">    if gitfetchall != 0:</span><br><span class="line">        print &quot;git fetch all fail&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    gitresetall = subprocess.check_call(&quot;git reset --hard origin/&quot; + BRANCH, shell=True)</span><br><span class="line">    if gitresetall != 0:</span><br><span class="line">        print &quot;git reset hard origin dev fail&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    gitpull = subprocess.check_call(&quot;git pull&quot;, shell=True)</span><br><span class="line">    if gitpull != 0:</span><br><span class="line">        print &quot;git pull fail&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    print &quot;git pull success&quot;</span><br><span class="line"></span><br><span class="line">    originContent = open(depgradlefilepath).read()</span><br><span class="line">    originVersionCodeLine = re.search(findline, originContent).group(0)</span><br><span class="line">    originVersionCodeString = re.search(findversion, originVersionCodeLine).group(0)</span><br><span class="line">    versionname = re.search(findversionname, originContent).group(0)</span><br><span class="line">    originVersionCode = int(originVersionCodeString)</span><br><span class="line">    finalVersionCode = originVersionCode + 1</span><br><span class="line">    finalVersionCodeLine = &quot;versionCode      : &quot; + str(finalVersionCode) + &quot;,&quot;</span><br><span class="line">    finalContent = originContent.replace(originVersionCodeLine, finalVersionCodeLine, 1)</span><br><span class="line">    open(depgradlefilepath, &apos;w&apos;).write(finalContent)</span><br><span class="line">    gitadd = subprocess.check_call(&quot;git add .&quot;, shell=True)</span><br><span class="line">    if gitadd != 0:</span><br><span class="line">        print &quot;git add failed&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    gitCommit = subprocess.check_call(</span><br><span class="line">        u&quot;git commit -m \&quot;build/auto increase versionCode = &quot; + str(</span><br><span class="line">            finalVersionCode) + &quot;,&quot; + msg + &quot;\&quot;&quot;,</span><br><span class="line">        shell=True)</span><br><span class="line">    if gitCommit != 0:</span><br><span class="line">        print &quot;gitCommit failed&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    gitPush = subprocess.check_call(</span><br><span class="line">        &quot;git push origin &quot; + BRANCH, shell=True</span><br><span class="line">    )</span><br><span class="line">    if gitPush != 0:</span><br><span class="line">        print &quot;gitpush failed&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    gitpull = subprocess.check_call(&quot;git pull&quot;, shell=True)</span><br><span class="line">    if gitpull != 0:</span><br><span class="line">        print &quot;git pull fail&quot;</span><br><span class="line">        sys.exit()</span><br><span class="line">    print &quot;git pull success&quot;</span><br><span class="line">    return finalVersionCode, versionname</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    if os.path.exists(&quot;release_apks&quot;):</span><br><span class="line">        shutil.rmtree(&quot;release_apks&quot;)</span><br><span class="line">        print &quot;delete exist release_apks success&quot;</span><br><span class="line">    os.mkdir(&quot;release_apks&quot;)</span><br><span class="line"></span><br><span class="line">    if os.path.exists(&quot;app/build&quot;):</span><br><span class="line">        shutil.rmtree(&quot;app/build&quot;)</span><br><span class="line">    print &quot;delete exist release_apks success&quot;</span><br><span class="line">    channel = &apos;dev&apos;</span><br><span class="line">    if len(sys.argv) &gt;= 2:</span><br><span class="line">        channel = sys.argv[1]</span><br><span class="line">    versionCodePlusPlus(channel)</span><br><span class="line">    release(channel)</span><br></pre></td></tr></table></figure>
<p>其中做了一个额外的动作，就是versioncode++这个操作，这个主要也是项目需要，每次build的包，需要有迹可溯，因此每次build都会使versioncode+1，并且进行提交。</p>
<p>上面是打包的流程，还有个全渠道打包的执行文件就比较简单了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from release import release, versionCodePlusPlus,BRANCH,findline,findversion,findversionname,depgradlefilepath</span><br><span class="line">import os</span><br><span class="line">import shutil</span><br><span class="line">import subprocess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FLAVOR_FILE = &apos;all_channels.txt&apos;</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    if os.path.exists(&quot;release_apks&quot;):</span><br><span class="line">        shutil.rmtree(&quot;release_apks&quot;)</span><br><span class="line">        print &quot;delete exist release_apks success&quot;</span><br><span class="line">    if os.path.exists(&quot;app/build&quot;):</span><br><span class="line">        shutil.rmtree(&quot;app/build&quot;)</span><br><span class="line">    print &quot;delete exist release_apks success&quot;</span><br><span class="line">    os.mkdir(&quot;release_apks&quot;)</span><br><span class="line"></span><br><span class="line">    versionCodePlusPlus(&apos;short&apos;)</span><br><span class="line">    release(&apos;short&apos;)</span><br><span class="line">    versionCodePlusPlus(&apos;middle&apos;)</span><br><span class="line">    release(&apos;middle&apos;)</span><br><span class="line">    versionCodePlusPlus(&apos;long&apos;)</span><br><span class="line">    release(&apos;long&apos;)</span><br></pre></td></tr></table></figure>
<p>因为也不算涉及到公司机密，以上都是很常规的操作，留下来做个备注防止以后采坑</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/22/viewstub的作用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/22/viewstub的作用/" itemprop="url">viewstub的作用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-22T23:53:18+08:00">
                2018-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>viewstub和merge标签基本上都属于android开发强求优化的时候需要注意的事情。</p>
<p>viewstub的大致作用是用于替换布局。与include这种将布局模块化的不同，viewstub主要的场景是用于分布加载，或者说延迟加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;ViewStub</span><br><span class="line">        android:id=&quot;@+id/map_stub&quot;</span><br><span class="line">        android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">        android:layout_height=&quot;fill_parent&quot;</span><br><span class="line">        android:inflatedId=&quot;@+id/map_view&quot;</span><br><span class="line">        android:layout=&quot;@layout/map&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>一般来讲viewstub就是这样，包含一个inflatedid，和一个layout，当viewstub被inflate时或者被设置为visiable时，viewstub属性就会消失，取而代之的是layout，并且此时viewstub的id也会消失，新的布局的id就是inflatedid，之后如果在要使用viewstub的布局的话，就需要直接调inflatedid了。viewstub老的id寻找的布局将为null</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/22/merge标签的作用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/22/merge标签的作用/" itemprop="url">merge标签的作用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-22T21:09:18+08:00">
                2018-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>merge标签的作用是用于减少一层布局的。</p>
<p>事实上很多时候如果单控件的话，可以直接使用控件来当root使用。</p>
<p>但是一旦控件比较多的话，那就没办法了，此时就需要使用merge标签来减少一层布局了。</p>
<p>merge标签一般的作用就是替代framelayout，当绘制绘制到他的时候，会主动跳过布局而直接绘制其包含的内容。但是缺点或者说局限就是只能使用framelayout的布局来布局。</p>
<p>另外merge只能用作根布局，且如果想使用inflater来inflate的话，attachtoroot一定要写成true</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/21/为什么在activity触发ondestroy的时候内部类可能产生泄露/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/为什么在activity触发ondestroy的时候内部类可能产生泄露/" itemprop="url">为什么在activity触发ondestroy的时候内部类可能产生泄露</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-21T18:41:36+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>基于内部类的泄露是android泄露的一个很常见的问题。</p>
<p>这方面自从使用了rxjava之后有很多好转，凡是内部类的我都会转换成为observable然后bindtolifecycle，这样通过生命周期的强制绑定，能够一定程度上面减少泄露发生的问题。</p>
<p>在lifecycle中，一般如果不指明的话，在start时订阅的事件将会在stop的时候dispose，在resume时订阅的事件将会在pause的时候dispose。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">switch (lastEvent) &#123;</span><br><span class="line">                case CREATE:</span><br><span class="line">                    return ActivityEvent.DESTROY;</span><br><span class="line">                case START:</span><br><span class="line">                    return ActivityEvent.STOP;</span><br><span class="line">                case RESUME:</span><br><span class="line">                    return ActivityEvent.PAUSE;</span><br><span class="line">                case PAUSE:</span><br><span class="line">                    return ActivityEvent.STOP;</span><br><span class="line">                case STOP:</span><br><span class="line">                    return ActivityEvent.DESTROY;</span><br><span class="line">                case DESTROY:</span><br><span class="line">                    throw new OutsideLifecycleException(&quot;Cannot bind to Activity lifecycle when outside of it.&quot;);</span><br><span class="line">                default:</span><br><span class="line">                    throw new UnsupportedOperationException(&quot;Binding to &quot; + lastEvent + &quot; not yet implemented&quot;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>生命周期就是上面这种，lifecycle在必要的地方做了很详细的处理，通过lifecyclesubject来根据绑定的生命周期来不断的发送接下来的activityevent（生命周期事件）。直到当发送下来一个取消的通知，之后就会取消订阅。</p>
<p>lifecycle的确很好用，但是没有办法所有的地方都使用到rxjava。因此关于内部类的泄露还是要明确讨论一下。</p>
<h1 id="内部类泄露"><a href="#内部类泄露" class="headerlink" title="内部类泄露"></a>内部类泄露</h1><p>回到内部类泄露的地方。android的内部类分为静态内部类和非静态内部类，内部类又分一些匿名的，成员的等等。非静态内部类会潜在的持有外部类的引用，因此当有耗时操作的时候，就会导致外部类的泄露。</p>
<p>activity在ondestroy的时候，凡是引用到他的内部类，假如没有结束的话，就会导致activity被泄露，因为activity是被强引用。</p>
<p>解决的方法其实看来很简单，1.在activity结束的时候强制释放掉2.将对activity的引用改为弱引用。</p>
<h1 id="引用细分"><a href="#引用细分" class="headerlink" title="引用细分"></a>引用细分</h1><p>引用只有四种：强引用（内存泄露罪魁祸首），软引用，弱引用，虚引用。</p>
<p>一般将强引用转化为弱引用即可避免强制引用带来的锅。</p>
<h1 id="loginChecker优化"><a href="#loginChecker优化" class="headerlink" title="loginChecker优化"></a>loginChecker优化</h1><p>代码中为了方便做登录的检查，同时为了防止包过大，没有使用切片，而是写了一个loginchecker辅助类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">package com.haomaiyi.base.util;</span><br><span class="line"></span><br><span class="line">import android.annotation.SuppressLint;</span><br><span class="line">import android.app.Activity;</span><br><span class="line">import android.text.TextUtils;</span><br><span class="line"></span><br><span class="line">import com.haomaiyi.base.updatemanager.Logger;</span><br><span class="line">import com.haomaiyi.fittingroom.AppApplication;</span><br><span class="line">import com.haomaiyi.fittingroom.domain.interactor.account.GetCurrentAccount;</span><br><span class="line">import com.haomaiyi.fittingroom.domain.model.account.Account;</span><br><span class="line">import com.haomaiyi.fittingroom.domain.model.account.AnonymousAccount;</span><br><span class="line">import com.haomaiyi.fittingroom.ui.LoginActivity;</span><br><span class="line">import com.orhanobut.hawk.Hawk;</span><br><span class="line">import com.trello.rxlifecycle2.LifecycleProvider;</span><br><span class="line"></span><br><span class="line">import javax.inject.Inject;</span><br><span class="line"></span><br><span class="line">import io.reactivex.Observable;</span><br><span class="line">import io.reactivex.android.schedulers.AndroidSchedulers;</span><br><span class="line">import io.reactivex.schedulers.Schedulers;</span><br><span class="line"></span><br><span class="line">@SuppressLint(&quot;CheckResult&quot;)</span><br><span class="line">public class LoginChecker &#123;</span><br><span class="line"></span><br><span class="line">    private static LoginChecker instance;</span><br><span class="line">    public LoginProceed proceed;</span><br><span class="line">    @Inject</span><br><span class="line">    GetCurrentAccount getCurrentAccount;</span><br><span class="line">    //    private boolean loginStat = false;</span><br><span class="line">    private int uid = -1;</span><br><span class="line">    private boolean logSuccess = false;</span><br><span class="line"></span><br><span class="line">    public LoginChecker() &#123;</span><br><span class="line">        AppApplication.getInstance().getUserComponent().inject(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static LoginChecker getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            synchronized (LoginChecker.class) &#123;</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new LoginChecker();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onLoginStart() &#123;</span><br><span class="line">        logSuccess = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onLoginFinish() &#123;</span><br><span class="line">        // TODO: 2018/9/30</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public LgnStat getLoginStat() &#123;</span><br><span class="line">        Account ac = getCurrentAccount.executeSync();</span><br><span class="line">        LgnStat stat;</span><br><span class="line">        if (ac instanceof AnonymousAccount) &#123;</span><br><span class="line">            stat = LgnStat.ANONYMOUS;</span><br><span class="line">        &#125; else if (TextUtils.isEmpty(ac.getPhonenumber())) &#123;</span><br><span class="line">            stat = LgnStat.NEED_NUMBER;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            stat = LgnStat.COMPLETE;</span><br><span class="line">        &#125;</span><br><span class="line">        return stat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getUid() &#123;</span><br><span class="line">        uid = getCurrentAccount.executeSync().getId();</span><br><span class="line">        return uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUid(int uid) &#123;</span><br><span class="line">        this.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void check(LifecycleProvider lifecycle, LoginCallback callback) &#123;</span><br><span class="line"></span><br><span class="line">        final Observable&lt;Account&gt; ob = getCurrentAccount.getObservable()</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread());</span><br><span class="line"></span><br><span class="line">        if (lifecycle != null)</span><br><span class="line">            ob.compose(lifecycle.bindToLifecycle());</span><br><span class="line"></span><br><span class="line">        ob.subscribe(ac -&gt; &#123;</span><br><span class="line">            uid = ac.getId();</span><br><span class="line">            LgnStat stat;</span><br><span class="line">            if (ac instanceof AnonymousAccount) &#123;</span><br><span class="line">                stat = LgnStat.ANONYMOUS;</span><br><span class="line">            &#125; else if (TextUtils.isEmpty(ac.getPhonenumber())) &#123;</span><br><span class="line">                stat = LgnStat.NEED_NUMBER;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                stat = LgnStat.COMPLETE;</span><br><span class="line">            &#125;</span><br><span class="line">            callback.onLogin(stat);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void loginAndproceed(Activity src, LifecycleProvider lifecycleProvider, LoginProceed proceed) &#123;</span><br><span class="line">        Logger.i(&quot;check=&quot; + this);</span><br><span class="line">        check(lifecycleProvider, new LoginCallback() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onLogin(LgnStat stat) &#123;</span><br><span class="line">                switch (stat) &#123;</span><br><span class="line">                    case ANONYMOUS:</span><br><span class="line">                        LoginChecker.this.proceed = proceed;</span><br><span class="line">                        LoginActivity.start(src);</span><br><span class="line">                        break;</span><br><span class="line">                    case NEED_NUMBER:</span><br><span class="line">                        LoginChecker.this.proceed = proceed;</span><br><span class="line">                        LoginActivity.start(src, LgnStat.NEED_NUMBER);</span><br><span class="line">                        break;</span><br><span class="line">                    case COMPLETE:</span><br><span class="line">                        proceed.onProceed();</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Must be called after cancel login behavior.</span><br><span class="line">     */</span><br><span class="line">    public void clear() &#123;</span><br><span class="line">        proceed = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Must be called after login success.</span><br><span class="line">     */</span><br><span class="line">    public boolean consume(int id, LoginActivity act) &#123;</span><br><span class="line">        uid = id;</span><br><span class="line">        Hawk.put(&quot;SHOW_GIFT&quot;, true);</span><br><span class="line">        if (proceed == null)</span><br><span class="line">            return false;</span><br><span class="line">        proceed.onLoginAndProceed(id, act);</span><br><span class="line">        proceed = null;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum LgnStat &#123;</span><br><span class="line">        // 匿名用户</span><br><span class="line">        ANONYMOUS,</span><br><span class="line">        // 有手机号</span><br><span class="line">        COMPLETE,</span><br><span class="line">        // 无手机号</span><br><span class="line">        NEED_NUMBER</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface LoginProceed &#123;</span><br><span class="line">        void onProceed();</span><br><span class="line"></span><br><span class="line">        void onLoginAndProceed(int id, LoginActivity act);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface LoginCallback &#123;</span><br><span class="line">        void onLogin(LgnStat loginStat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个类虽然不是内部类，但是其携带的内部类以接口形式获取了activity，以activity作为实例，做了一些别的事情。而且有个最重要的问题，就是启动loginactivity的时候使用的是获取的实例。同时整个类又绑定了lifecycle。这就导致了一个很有趣的问题，就是当使用实例来启动的时候触发了onpause和onstop，此时刚好gc，导致无法回收。</p>
<p>因此此时需要更改几个地方，一是不在使用原来传过来的activity，改用application的context，这样就不会再出现强制捆绑的地方。其次是将该类中使用到的任何引用的地方改成weakreference。atu</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/20/android渠道包打包取舍以及打包流程分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/20/android渠道包打包取舍以及打包流程分析/" itemprop="url">android渠道包打包取舍以及打包流程分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-20T16:20:28+08:00">
                2018-10-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前述"><a href="#前述" class="headerlink" title="前述"></a>前述</h1><p>刚开始接手好搭的时候，用的是美团的多渠道打包方案，但是当时前人写的代码有些问题。</p>
<p>当时的流程大致是：打包一个包，然后解压，修改META-INFO,之后重新压缩，过程中会生成一个额外的包含渠道名的文件。</p>
<p>这样的好处是解压之后重新压缩，并不需要重新编译，也不需要重新签名。</p>
<p>但是当时在apk启动的时候使用的读取渠道包的方式也是和官网提供的一样，没有变化。是启动时解压apk，然后读取相对应的文件。</p>
<h1 id="过去方式的缺点"><a href="#过去方式的缺点" class="headerlink" title="过去方式的缺点"></a>过去方式的缺点</h1><p>由于需要启动的时候解压apk，整个过程耗时大约200ms，而且是每次都会出现的。加上前人对于性能的优化也不是很在心，当时刚接手的时候启动速度十分慢（大约1-2秒的卡顿）。</p>
<p>后来不得已，出于性能的考虑，对这个动了刀子。</p>
<h1 id="变化"><a href="#变化" class="headerlink" title="变化"></a>变化</h1><p>由于刚开始的渠道包并不算太多，因此第一个考虑就是使用gradle的变体来进行更改。</p>
<p>变体是官方提供的，使用变体的话，平时打包也可以直接选定打什么包。对于项目来讲，省了不少时间。</p>
<h1 id="变体带来的缺点"><a href="#变体带来的缺点" class="headerlink" title="变体带来的缺点"></a>变体带来的缺点</h1><p>后期由于项目规模大了起来，增加了5个渠道，全渠道打包时间一下子长了很多，由刚开始的40分钟，猛增到一小时20多分钟。同时市场那边的意思是后期还会继续扩充渠道。</p>
<p>因此现在必须要更改一下这个打包方式。</p>
<h1 id="想法1-raw"><a href="#想法1-raw" class="headerlink" title="想法1-raw"></a>想法1-raw</h1><p>第一种想法是脱离美团打包，通过自己设置资源文件夹下面的raw目录，来进行打包，raw文件在android里面是不会编译成二进制文件的，会原样保留到apk里面。在app启动的时候直接读raw文件。<br>但是这种想法刚说出来就被进奎否了，当时的问题出在raw文件需要进行重新编译，否则不会出现在R.java中，而如果使用apktool重新编译，效率基本上和变体是55开。</p>
<h1 id="想法2-asset"><a href="#想法2-asset" class="headerlink" title="想法2-asset"></a>想法2-asset</h1><p>第二种想法是第一种想法的补充，既然raw文件需要通过编译来生成r，那我们找一个不需要编译的，想法很简单，打包之后直接塞一个文件到asset里面，这个文件就是配置文件，每次打包之后，解压，然后复制相对应渠道的配置文件到asset里面，这样就可以避免需要回编译的目的了。但是这个方法需要进行重新签名。</p>
<h1 id="想法3-美团方案优化"><a href="#想法3-美团方案优化" class="headerlink" title="想法3-美团方案优化"></a>想法3-美团方案优化</h1><p>在目前不需要配置额外的配置目录的情况下，想法2其实是有些牛刀小用了。事实上我们完全可以在美团的打包方案上面进行优化。美团提供的打包方案，当时细细想想，完全没有必要每次启动apk的时候都去读取。仅仅需要第一次打开app的时候，读取并写入sp中，之后每次读取sp，如果没有在去重新读取即可。这样可以省了好多事情。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>鉴于目前项目的规格以及需求，仅仅在需要扩充渠道的时候，仅仅需要重启美团的优化方案，同时优化每次编译的选项即可。但是在后续需要用到不同配置文件的时候，就需要使用想法2的方法，美团的方案不够支持那么详细。</p>
<p>同时鉴于此，也算研究了一下app打包流程，顺便总结一下。</p>
<h1 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h1><p><img src="/images/android/androidpackageimage.png" alt="打包流程"></p>
<p>从官方图可以很明显的看出流程变化。</p>
<ol>
<li>资源文件是通过aapt来进行打包的，aapt全称是Android Asset Packaging Tool，可以看出来，aapt打包生成了2个东西，一个是R,一个是compiled resources，像想法一之中的raw就是生成在r里面，compiled resources 是asset文件夹下面的东西，这些东西不会参与打包，而是直接被压缩进apk.</li>
</ol>
<p>关于asset和raw我之前一直认为raw是原封不动，不会编译成二进制，今天才知道两个相同点都是原封不动不会被编译成二进制。差别就是读写方式不同。因此想法1本来就是错误的。</p>
<ol>
<li><p>java编译器同时编译三者，一是代码，二是r文件，三是aidl编译下来的java接口。编译成class之后，然后和第三方class一起并到dex中（dex是好几个class合并起来的）。<br>看到这边有个疑问，为什么是class？我们所知道的第三方包，有时候是使用aar的形式来进行依赖的，aar包含了资源文件，但是我查了一下，如果是aar的话。将会被打包到class.jar中，应该就是先打包到jar中，然后又会被放到dex中</p>
</li>
<li><p>asset， resource， dex 三者就可以打包成一个apk了，此时使用apkbuilder即可，打包成一个未签名的apk。</p>
</li>
<li><p>apk好了之后使用jarsigner来进行签名</p>
</li>
<li><p>按理说签名完之后就应该结束了，为什么还会有个zipaligh呢？</p>
</li>
</ol>
<p>zipalign的效果：zipalign是一个对齐工具，android基于linux，因此资源也是仿照linux来的，在多进程需要寻找资源的时候，最好的方式是按照linux架构来设计数据摆放位置，因此最好的是放在4字节层，这样子的话系统就不需要读取所有的文件，而直接可以类似链表的形式知道什么资源在什么地方。这样节省了大量的内存。因此这个步骤我们称之为对齐</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/binder机制学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/binder机制学习/" itemprop="url">binder机制学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-18T22:42:23+08:00">
                2018-10-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>binder平时总听过，但是原理只知道是ipc，也就是进程间通信。但是真正的原理其实还是不理解。</p>
<h1 id="binder位置"><a href="#binder位置" class="headerlink" title="binder位置"></a>binder位置</h1><p>binder介于framework和systemservice之间，属于让开发者来调用系统层接口的方法。</p>
<h1 id="ipc"><a href="#ipc" class="headerlink" title="ipc"></a>ipc</h1><p>ipc全称是inter-process communication,进程间通讯</p>
<p>ipc的方式有很多种，socket，共享内存，管道，消息队列</p>
<h2 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h2><p>socket实现进程间通讯，是基于tcpip协议来实现的，一般实现tcp，如果是udp也是可以的，udp是两个socket但是无连接。<br>通过tcp实现ipc的原理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端程序通过socket发送一系列信息到传输层的tcp，然后往下传，通过网络层，网络接口层，然后在往上传到网络层，然后传到服务端的传输层tcp，然后由服务器的socket接收到，之后回传也是相同的</span><br></pre></td></tr></table></figure></p>
<p>缺点是需传输效率较低，一般只用在不同机器，或者跨网络的通行</p>
<h2 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h2><p>共享内存的ipc，传输的对象一般都是可描述的，所以都用序列化，创建共享内存就使用memoryfile即可</p>
<p>这样构建的内存可以让其他进程共享</p>
<p>共享内存的优点在于无需复制，速度快，共享缓冲区直接附加到进程虚拟地址空间。缺点在于同步问题不好解决</p>
<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p>消息队列就是messagequeue<br>实现的思路<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在进程a中创建一个message，讲这个message对象通过imessenger.send(message)方法传递到进程b中</span><br><span class="line">send(message)会使用一个parcel对象对message对象编集，再将parcel对象传递到进程b中，然后解编集，得到一个和进程a中message对象内容一样的对象，在将message对象加入到b的消息队列里面，handler会处理它</span><br></pre></td></tr></table></figure></p>
<p>消息队列的好处是比较方便，缺点是信息复制2次，有额外的cpu消耗，不是很适合频繁或者信息量大的通信</p>
<h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>管道是比较古老的通信方式，包括无名管道和有名管道，前者是父子进程间的通信，后者用于运行同一机器上的任意两个进程间的通信。实现方式是pipe，利用管道的有handler（此处需要研究一下handler的实现原理）</p>
<p>管道创建时分配了一个page大小的内存（page？）缓存区大小比较有限</p>
<h1 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h1><p>binder ipc属于c/s结构，client部分是用户代码，最终会调用binder driver的transact接口，binder driver会调用server</p>
<p>client:用户需要实现的代码，如aidl自动生成的接口类<br>binder driver：在内核层实现的driver<br>server：这个server就是service中onbind返回的ibinder对象</p>
<p>binder driver这块并不需要用户知道，server中会开启一个线程池（防止任务积压，也需要做好同步措施）去处理客户端调用</p>
<p>对于调用binder driver中的transact接口，客户端可以手动调用，也可以通过aidl的方式生成的代理类来调用，服务端可以继承binder对象，也可以继承aidl生成的接口类的stub对象</p>
<h1 id="实现环节"><a href="#实现环节" class="headerlink" title="实现环节"></a>实现环节</h1><p>//todo</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/10/2018第三季度复盘（第40周）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/2018第三季度复盘（第40周）/" itemprop="url">2018第三季度复盘（第40周）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-10T21:04:59+08:00">
                2018-10-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>十一国庆过去了，回首一年过去3/4了，有必要做一个复盘操作了。</p>
<ul>
<li>项目</li>
</ul>
<p>过去的这些时间里面，绝大多数时间在项目中度过。<br>刚开始独自一个人完成了软件从1.9.3到2.0.1一个大版本一个小版本的升级，之后进奎来了，两个人协助做了2.0.1到2.0.6版本的升级，然后又加了苏展，三个人从2.0.6升到了现在的2.3.0。</p>
<p>细数了一下，在好搭的7个月里面，完成了11个版本。</p>
<p>版本升级其实很耗费精力，尤其是换了3个产品，3个ui，设计风格都推翻重来了几次，更是极度累的。</p>
<p>刚开始我以为我不会撑到试用期结束，后来我以为我不会撑过半年，结果也都撑过来了。长叹一声。</p>
<p>项目的细节基本上都总结在工作小结里面了，所以略过不表。</p>
<ul>
<li>读书</li>
</ul>
<p>开年计划，准备读够10本书，并以此列了一些书单，但是后期项目忙了，大部分都鸽了，目前读了《Android群英传》、《javascript dom编程艺术》和《博弈论》，但是只能说读过。<br>目前在读的《effective-java》算是做了一些笔记，不过才读到第六章，还有四章，估计月内能读完吧。<br>之后需要读的就是《http权威指南》，说来发笑，做移动端的居然没读过这个，这个是决定月内要开读的。<br>另外上次写的《csapp》这本书，仔细看看，实在是太过底层。底层打基础虽好，但是对目前这个阶段是没有什么意义的。<br>读书暂时不立宏愿了。</p>
<ul>
<li>减肥</li>
</ul>
<p>失败</p>
<ul>
<li>掌握新的语言</li>
</ul>
<p>失败，俄语只能喊ypa</p>
<ul>
<li>github每日更新</li>
</ul>
<p>失败，这个原因比较多，最大的原因是工作繁忙，另外染上了游戏的恶习，还好迷途知返。</p>
<ul>
<li>戒烟</li>
</ul>
<p>失败</p>
<ul>
<li>健身房一周去2-3次</li>
</ul>
<p>因为搬家健身房卡已经转让，不能说失败吧，至少当时是每周都去2-3次</p>
<ul>
<li>每日早饭必须要吃</li>
</ul>
<p>成功</p>
<ul>
<li>23:00前必须睡</li>
</ul>
<p>失败</p>
<ul>
<li>下一阶段计划</li>
</ul>
<p>此计划只适合个人</p>
<ol>
<li>晚上只吃一碗饭</li>
<li>github每日更新</li>
<li>制作自动化脚本，和建宇合作，看看能不能出售</li>
<li>没了</li>
</ol>
<p>此次计划比较简洁明了，可行性比较高。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/2018第三十七周工作小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/2018第三十七周工作小结/" itemprop="url">2018第三十七周工作小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T09:49:14+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上周大概做了几件小事，一是完善了app的相关细节，二是修了很多medel的bug，三是发了个版。很惭愧。</p>
<p>现在想来上周有两件事做的不好，一是读书，effective-java大概看了三次，但是一章都没看完。二是娱乐，赶上了中秋，却躺了三天。</p>
<p>上周从网上打印了本csapp，这周开读吧。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/16/2018第三十六周工作小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/16/2018第三十六周工作小结/" itemprop="url">2018第三十六周工作小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-16T22:51:04+08:00">
                2018-09-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本周主要任务是2.2.1的迭代计划，自从2.2.0发版以后，小程序端，ios端的进度都大大落后于android。我们也进入了喜闻乐见的等进度阶段。</p>
<p>本周个人主要负责商品详情页面的优化。这次主要是借鉴淘宝的布局，做了较大量的优化。</p>
<p>优化方面一是接口部分的抽离，将逻辑部分放在p层，视图放在v层，隔离开来，逻辑因此较为清晰，对比前人的过程式编程，感觉光编译器编译都快了很多。</p>
<p>优化第二方面是布局的优化，还是老样子，一层constaintlayout解决问题。从爆红的过度绘制一下子变成了淡绿，打开页面的速度也快了很多。</p>
<p>优化第三方面是父类的精简，经过仔细排查，最终抽丝剥茧下来了一个比较简单的activitybase，上层是rxactivity，在上层就是appcompatactivity。对比之前的fragmeng-&gt;appbasefragment-&gt;basefragment-&gt;rxbasefragment,以及对应的activity，光这一方面就精简了8层。打开速度快也不是没有原因的。</p>
<p>优化第四方面是接口的生命周期绑定，之前只是在ondestroy中集中处理了接口，但是大部分的跳转，切换，接口并未做处理，这样在接口请求时切换了，就造成了泄漏。这次直接统一compose到了rxlifecycle中，连destroy中都不需要处理。</p>
<p>不过这次让做一个属性动画，加入购物车的时候进行弹跳的一个动画布局，我搞了2天，原本准备搞个抛物线结束，结果三点计算抛物线公式忘了，自己推了2个小时，还推了个错的，debug了半天才发现。之后和ios商量，他们说应该用贝塞尔曲线，我又去翻以前的贝塞尔曲线的笔记，结果公式是以前就总结好的，但是好像是错的，怎么画都不对头。网上找了一圈还是没找到相关的对的例子。明天上班的时候去和ios的讨论讨论。</p>
<p>以上为本周的工作内容。</p>
<p>最近沉迷dnf无法自拔，结果今天给封号了一天，日。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/29/2018八月-第三十一周到三十五周-工作小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sample">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记录者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/29/2018八月-第三十一周到三十五周-工作小结/" itemprop="url">2018八月-第三十一周到三十五周-工作小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-29T18:37:05+08:00">
                2018-08-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个月都没有写小结，发生了很多事情，都没有来的及记录。</p>
<p>首先是公司进入了a轮的加速期，为了提高转化率使投资人满意，所有人都进入了8月的倒计时奋战期。其实和之前差不多，唯一变的是每周一开需求大会，之前都会假意征求一下开发的意见，现在这个流程也省略了。</p>
<p>其次是由于好几个前端跑路，导致之前做的很多动态页面需要本地化，也相当于增加了业务量。</p>
<p>这个月基本上是围绕着优化，订单来工作的。</p>
<p>首先讲讲优化。</p>
<ul>
<li>ui优化</li>
</ul>
<p>app在oppor9m上面贼卡，一方面是过度绘制比较严重，二方面是内存泄漏比较严重。之前写布局很多地方都用的relativylayout或者framelayout，嵌套比较严重，红色过度绘制的区域十分多，查看gpu绘制，发现滑动的时候绘制较多，在专题详情页面尤其明显。</p>
<p>– 过度绘制</p>
<p>因此对主要流程，主要流程的卡顿页面做了调整，完全按照constraintlayout的设计规则，无论多复杂的布局，统一使用一层或者2层（带scrollview）的布局结构。写的十分顺畅，使用的过程中完善了我对于constraintlayout的理解，包括guideline，group，基准点等。constraintlayou有一个问题，就是背景问题，以往的情况下，习惯性的使用linearlayout，或者部分布局包装，然后针对包装布局进行背景设置，但是在constraintlayout下面，其实单层布局不是很好设置背景，只可以使用单独的一层view来在之前设置，但是view的下方padding就有一些问题，尤其是在提前布局的情况下。针对这个情况，我通过guideline和viewtip来解决，不过这样多了很多奇怪的点，这些点也只可以通过group来进行布局的绑定。</p>
<p>整个constraintlayout给我的感觉，是牺牲了逻辑效率，带来布局效率，很多的逻辑牵扯在的xml中，而代码中我们一般指判断view是否显示，但是这样就会导致xml中的部分逻辑在不显示的情况下，产生了偏差。因此我觉得在大多数遇到逻辑复杂的布局排列中，还是不要轻易强行单层布局，逻辑偏差带来的时间损失，绝对比使用嵌套布局之后在进行代码优化的多。</p>
<p>– bitmap大图</p>
<p>由于我们的项目就是围绕着人脸，身材，妆容这些来进行的，这些无一例外都是bitmap的使用者。</p>
<p>整合人脸，整合身材，整合妆容之后形成的完整的人模型，原本需要占用大约5m的内存。在优化之前，很多地方使用的是fragmentpageradapter，每个fragment持有很多的bitmap，当时算了一下，一个framgent如果在不上滑加载更多的时候，会持有8个bitmap对象，就是约40m内存。</p>
<p>在2.1.3版本上面，anr的发生率提高到了14%，绝大多数都是在首页滑动的时候产生的卡死。</p>
<p>针对这个问题，也做了针对性的优化。首先是使用fragmentstatepageradapter，这样可以在fragment进入销毁流程的时候，释放引用而让他自然销毁。这样首先是切换的时候内存占用问题解决了。</p>
<p>其次是单fragment下滑导致的内存占用问题。刚开始使用的recyclerview，为了让用户有比较好的体验（雾），而将最大item设为了20（大雾）。这下子用户上滑超过20个，光bitmap 的占用率就飙升到了100m，还不谈item的其他内存占用问题。在一般的华为和oppo手机上面，光这项就吃掉了分给app的50%以上的内存。基本上这个时候如果系统在吃点内存，app就anr了。</p>
<p>因此针对这个问题，想到的是动态持有，根据可用内存堆分配来实时更新缓存堆的内容。使用的是比较常见的lrucache，但是这个lrucache只缓存了bitmap的信息，item其余的信息就直接释放了，这样动态缓存1/4最大内存堆的内存，同时也保证了bitmap加载不会有太多的问题。</p>
<p>使用缓存有个小问题，就是强制刷新的时候不注意的话其实是无法清除的，强制刷新的时候得clearcache。</p>
<p>– bimap色深</p>
<p>在解决了缓存占用问题之后，基于bitmap的内存问题其实得到了很大的解决。但是仍然有一个巨大的问题，就是bitmap的加载速度。</p>
<p>即使缓存到lrucache里面，也得首先下载下来，在普通4g网大约200K下载速度的时候，一张基准图下载需要大约0.5-1秒，但是经过渲染和加载，总共大约需要1.5秒的样子才可以呈现，这个速度实在是很慢。</p>
<p>处理这个的问题一般就是从图片质量上面入手，图片存储方式一般是写死的，虽然我们使用的是oss，可以通过传递参数到服务器，来获取不同的图片大小，但是在做到这个地步之后，就是图像的渲染，也就是从网上下载的数据映射到bitmap上面的这个过程。</p>
<p>一般的bitmap是rgb888，一个像素占3Byte，我用的手机5.5英寸，1080x1920像素，一般图片设置大约140dp宽高，也就是约420x420像素，占用内存就是420x420x3 = 516K,jpg的压缩率我不是很清楚，大约在10%-90%之间，也就是这么一个呈现为516k的图片，大约需要下载5-50k之间的样子，专题详情页面的大图，宽度是130dp，高度是400dp，就一下子扩了将近3倍，下载如果在200k就要全速一秒了。</p>
<p>流量并不是很关心的事情，下载其实也不是很关心的事情，因为我无法决定用户的网速，那是framework的事情，我只可以确保下载的内容到本机能够快速加载出来。因此采取的措施是压缩色深，从rgb888，压缩到rgb565，然后压缩到了rgb444。图片质量压缩到如此之低，基本上是能接受的极限了。改完之后速度大约快了一点，加载的时候下载完的条结束就可以出来了。</p>
<p>– 主线程任务过多引起的卡顿</p>
<p>在sku详情页面，逻辑是这样的，2线并行，1线先请求人体数据，人体数据的返回值会引起整个页面结构的初始化，2线后行，直接请求sku的数据，进行数据的web填充。问题出现在这两条线都涉及到了ui的修改，所以都跑在主线程，还有个问题是双线有依赖，会导致加载的时候互相调用，而在安卓中很少对于view进行上锁措施，因此此时的操作极为繁琐，而且卡顿及其严重。</p>
<p>针对此问题主要是优化主线程任务措施，rxjava中其实还是比较好做的，一来使用concat操作符，二来在数据初始化的步骤可以放到子线程，之后实现的操作可以放到主线程，逻辑复杂的部分可以放在子线程，结果传到主线程。（此处mark一下，需要对rxjava的原理做个完整的学习）</p>
<p>双线我通过整合成为单线，然后线程切换的方式，加载速度，滑动速度响应都足够了。</p>
<ul>
<li>性能优化</li>
</ul>
<p>– 内存泄漏</p>
<p>之前项目中整合了lecancary，每次gc和泄漏的时候会弹出提示，但是在项目中的表现并不好，一来是fragment和activity的多层引用，基类中有很多资源持有引用，而这些引用是后来自己手动释放的，但是在lecancary中就会爆这些引用泄漏了，其二是我们所有的网络代码通过clean的结构，在最顶层使用dagger来解耦，因此造成了在ondestroy过程中会销毁，但是切换过程中并不会销毁。切换的过程需要等待，但是这个过程已经造成了泄漏。</p>
<p>采取的措施比较粗暴，就是直接在切换的时候触发presenter的destroy方法，这样切换的时候，会先关闭引用，之后在切换，切换之后销毁自己，这就是比较正常的过程了。</p>
<p>– oom</p>
<p>oom的问题就如同bitmap大图的问题，掠过不讲</p>
<ul>
<li>订单流程</li>
</ul>
<p>整个订单流程进行了完整的更新，大部分计算价格的部分给予后台来处理，不在由前端显示相关内容，对于我们来讲逻辑更新容易很多。出问题的地方是由于都给予后台显示了，前端势必要判断是否成功，失败的处理逻辑等等。因此针对网络失败的地方做了处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void handleHttpError(Throwable e)&#123;</span><br><span class="line">        if (e instanceof RuntimeException)&#123;</span><br><span class="line">            if (e.getCause() instanceof ConnectException)&#123;</span><br><span class="line">                mEventBus.post(new OnHttpErrorEvent(&quot;连接失败，请检查网络后再试&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (e.getCause() instanceof SocketTimeoutException)&#123;</span><br><span class="line">                mEventBus.post(new OnHttpErrorEvent(&quot;请求超时，请检查网络后再试&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (e.getCause() instanceof UnknownHostException)&#123;</span><br><span class="line">                mEventBus.post(new OnHttpErrorEvent(&quot;域名连接失败，请检查网络后再试&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (e.getCause() instanceof NetworkErrorException)&#123;</span><br><span class="line">                mEventBus.post(new OnHttpErrorEvent(&quot;网络异常，请检查网络后再试&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (e instanceof ConnectException)&#123;</span><br><span class="line">            mEventBus.post(new OnHttpErrorEvent(&quot;连接失败，请检查网络后再试&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        if (e instanceof SocketTimeoutException)&#123;</span><br><span class="line">            mEventBus.post(new OnHttpErrorEvent(&quot;请求超时，请检查网络后再试&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        if (e instanceof UnknownHostException)&#123;</span><br><span class="line">            mEventBus.post(new OnHttpErrorEvent(&quot;域名连接失败，请检查网络后再试&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        if (e instanceof NetworkErrorException)&#123;</span><br><span class="line">            mEventBus.post(new OnHttpErrorEvent(&quot;网络异常，请检查网络后再试&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>处理方式如上，主要是针对rxjava网络异常的各个问题进行鉴别性操作，然后根据不同的类型显示不同的页面。</p>
<p>大致分了2种页面，一种是正常的失败，没有数据的那种，叫emptyview，还有一种就是网络失败的，叫errorview，都是可以抽出来单独做的。</p>
<p>除此之外由于大多都是业务方面的内容，可总结的比较少。</p>
<p>能够抽出来说的有一点，是优惠卷的ui处理方面，一般是使用recyclerview，但是由于用户的优惠卷比较少，我使用的是普通的linearlayout，通过addview来进行加载视图，问题是无法通过recyclerview那种通过一张表来更改数据和view。我需要维护2个表，一个是选中的view表，一个是所有的view表，每次点击的时候需要从选中表中进行遍历，然后处理一些关于选中优惠卷的县骨干内容，本次版本主要是互斥卷和叠加卷的逻辑问题。处理完之后会重新刷新选中表。这样一定程度上是牺牲了代码简洁，而照顾了加载速度。其实recyclerview也有很多bug，比如说每次notifydatasetchanged，数据源变更会强制触发重新刷新的功能，这就不适合数据源并不多的情况。而且recycerview本身作为一个较为重型的控件，处理单纯的几个view，有些大材小用。</p>
<p>大致如上，四周都没什么时间好好整理一下，做项目的时候总是想着要总结总结，但是到了要总结的时候，仿佛踩过的坑，处理过的问题，都一下子不见了。脑袋里就剩下了最近处理的一些问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Sample</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">110</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sample</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
